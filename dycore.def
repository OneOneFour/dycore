Bootstrap: docker
From: robcking/eddy-builder
Stage: builder

%files
./src /opt/dycore/src
./bin /opt/dycore/bin
./input /opt/dycore/input
./postprocessing /opt/dycore/postprocessing

%post 
 HDF5_INC=/opt/hdf5/include
 HDF5_LIB=/opt/hdf5/lib
 NETCDF_INC=/opt/netcdf-c/include
 NETCDF_LIB=/opt/netcdf-c/lib
 NETCDF_FORTRAN_INC=/opt/netcdf-fortran/include
 NETCDF_FORTRAN_LIB=/opt/netcdf-fortran/lib 
 mkdir /opt/dycore/build
 cd /opt/dycore/build
 export cppDefs="-Duse_libMPI -Duse_netCDF -DgFortran"
 export FFLAGS="-O3 -i4 -r8 -g `nf-config --fflags` `nc-config --fflags`  `nc-config --cflags` -cpp"
 export CFLAGS="-g `nc-config --cflags` `nf-config --cflags`"
 export LDFLAGS="-shared-intel `nf-config --flibs` `nc-config --libs` "
 mkmf=/opt/dycore/bin/mkmf
 sourcedir=/opt/dycore/src

 ${mkmf} -p dycore -t /opt/dycore/bin/mkmf.template.singularity -c"-Duse_libMPI -Duse_netCDF -DgFortran" -a /opt/dycore/src /opt/dycore/input/spectral_pathnames;
 make -f Makefile clean
 make -f Makefile 
 chmod +x /opt/dycore/build/dycore

%environment
  PATH=/opt/netcdf-fortran/bin:/opt/netcdf-c/bin:/opt/intel/oneapi/mpi/latest/bin:/opt/intel/oneapi/compiler/latest/linux/bin/intel64:${PATH}
  LD_LIBRARY_PATH=/opt/netcdf-c/lib:/opt/hdf5/lib:/opt/netcdf-fortran/lib:/opt/io_libs/lib:${LD_LIBRARY_PATH}

%runscript
    ulimt -s unlimited
    /opt/dycore/build/dycore